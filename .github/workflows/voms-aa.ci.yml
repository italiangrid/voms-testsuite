name: Run testsuite

on: push

env:
  server_beta: v1.12.0.rc3
  server_stable: v1.11.0
  client_beta: 9-beta
  client_stable: 7-stable

jobs:
  run_testsuite_vomsaa:
    name: ${{ matrix.server }} (voms-aa), ${{ matrix.client }}

    strategy:
      matrix:
        client: [client_beta, client_stable]
        server: [server_beta, server_stable]

    runs-on: ubuntu-latest

    continue-on-error: true

    env:
      ROBOT_OPTIONS: --variable vo1:vo.2 --variable vo1_host:voms-aa.test.example --variable vo1_issuer:'/C=IT/O=IGI/CN=voms-aa.test.example' --variable vo2:vo.1 --variable vo2_host:voms.test.example --variable vo2_issuer:'/C=IT/O=IGI/CN=voms.test.example' --exclude issue-723 --exclude issue-724 --exclude issue-726

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start compose
        run: |
          docker compose --file docker-compose.ci.yml build --no-cache trust
          docker compose --file docker-compose.ci.yml up --detach trust db voms testsuite vomsaa ngx
        working-directory: compose
        env:
          TS_IMAGE: italiangrid/voms-testsuite:centos${{ env[matrix.client] }}
          VOMS_IMAGE: italiangrid/voms:centos7-stable
          VOMS_AA_IMAGE_TAG: ${{ env[matrix.server] }}

      - name: Deploy db and voms
        run: |
          docker compose --file docker-compose.ci.yml exec -T --workdir /scripts db bash /scripts/populate-db.sh
          docker compose --file docker-compose.ci.yml exec -T --workdir /scripts voms bash /scripts/setup-and-start-voms.sh
        working-directory: compose

      - name: Create artifacts dir
        if: ${{ always() }}
        run: |
          ARTIFACTS_PATH=${HOME}/artifacts
          echo ARTIFACTS_PATH: ${ARTIFACTS_PATH}
          # save it in the job environment
          echo "ARTIFACTS_PATH=${ARTIFACTS_PATH}" >> ${GITHUB_ENV}
          mkdir -p ${ARTIFACTS_PATH}/logs ${ARTIFACTS_PATH}/java ${ARTIFACTS_PATH}/cpp

      - name: Enable legacy OpenSSL crypto policies on EL9
        if: matrix.client == 'CLIENT_BETA'
        run: docker compose --file docker-compose.ci.yml exec -T testsuite bash -c "sudo update-crypto-policies --set LEGACY"
        working-directory: compose

      - name: Run testsuite for java clients
        run: docker compose --file docker-compose.ci.yml exec -T -e ROBOT_OPTIONS="${ROBOT_OPTIONS}" testsuite bash /scripts/ci-run-testsuite.sh
        working-directory: compose
        continue-on-error: true


      - name: Collect test report for java clients
        if: ${{ always() }}
        run: docker compose --file docker-compose.ci.yml cp testsuite:/tmp/reports ${ARTIFACTS_PATH}/java
        working-directory: compose

      - name: Run testsuite for cpp clients
        run: |
          docker compose --file docker-compose.ci.yml exec -T -u root testsuite bash -c "update-alternatives --set voms-proxy-init /usr/bin/voms-proxy-init2; update-alternatives --set voms-proxy-info /usr/bin/voms-proxy-info2; update-alternatives --set voms-proxy-destroy /usr/bin/voms-proxy-destroy2"
          docker compose --file docker-compose.ci.yml exec -T -e ROBOT_OPTIONS="${ROBOT_OPTIONS}" testsuite bash /scripts/ci-run-testsuite.sh --variable client_version:2 --include legacy
        working-directory: compose
        continue-on-error: true

      - name: Collect test report for cpp clients
        if: ${{ always() }}
        run: docker compose --file docker-compose.ci.yml cp testsuite:/tmp/reports ${ARTIFACTS_PATH}/cpp
        working-directory: compose

      - name: Collect summary report
        if: ${{ always() }}
        run: |
          cpp_result=$(cat ${ARTIFACTS_PATH}/cpp/reports/report.html | grep '^window.output\["stats"\]' | sed -e 's/window.output\["stats"\] = //' -e 's/;$//')          
          cpp_passed_tests=$(echo "${cpp_result}" | jq .[0][0].pass)
          cpp_failed_tests=$(echo "${cpp_result}" | jq .[0][0].fail)
          cpp_client_version=$(docker compose --file docker-compose.ci.yml exec -T testsuite bash -c "voms-proxy-init2 -version " | grep '^Version:' | awk '{print $2}')

          java_result=$(cat ${ARTIFACTS_PATH}/java/reports/report.html | grep '^window.output\["stats"\]' | sed -e 's/window.output\["stats"\] = //' -e 's/;$//')
          java_passed_tests=$(echo "${java_result}" | jq .[0][0].pass)
          java_failed_tests=$(echo "${java_result}" | jq .[0][0].fail)
          java_client_version=$(docker compose --file docker-compose.ci.yml exec -T testsuite bash -c "voms-proxy-init3 -version" | awk '{print $3}')

          server_var="${{ matrix.server }}"
          server_version="${!server_var}"

          result_json="{\"client\":\"${{ matrix.client }}\",\"server\":\"${{ matrix.server }}\",\"cpp_passed_tests\":${cpp_passed_tests},\"cpp_failed_tests\":${cpp_failed_tests},\"java_passed_tests\":${java_passed_tests},\"java_failed_tests\":${java_failed_tests},\"cpp_client_version\":\"${cpp_client_version}\",\"java_client_version\":\"${java_client_version}\",\"vomsaa_version\":\"${server_version}\"}"
          echo "$result_json" > ${ARTIFACTS_PATH}/result-${{ matrix.client }}-${{ matrix.server }}.json
        working-directory: compose

      - name: Collect logs
        if: ${{ always() }}
        run: |
          docker compose --file docker-compose.ci.yml logs --no-color testsuite > ${ARTIFACTS_PATH}/logs/testsuite.log
          docker compose --file docker-compose.ci.yml logs --no-color vomsaa > ${ARTIFACTS_PATH}/logs/voms.log
        working-directory: compose

      - name: Stop compose
        if: ${{ always() }}
        run: docker compose --file docker-compose.ci.yml down --volumes
        working-directory: compose

      - name: Upload artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-report-and-logs_${{ matrix.client }}_${{ matrix.server }}
          path: ${{ env.ARTIFACTS_PATH }}

  publish-results:
    runs-on: ubuntu-latest
    needs: [run_testsuite_vomsaa]
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: results

      - name: Generate summary
        run: |
          ARTIFACTS_PATH=results
          # Init empty cells
          declare -A cpp
          declare -A java
          for file in ${ARTIFACTS_PATH}/**/result-*.json; do
            json=$(cat "$file")
            client=$(echo "$json" | jq -r .client)
            server=$(echo "$json" | jq -r .server)
            cpp_passed=$(echo "$json" | jq -r .cpp_passed_tests)
            cpp_failed=$(echo "$json" | jq -r .cpp_failed_tests)
            java_passed=$(echo "$json" | jq -r .java_passed_tests)
            java_failed=$(echo "$json" | jq -r .java_failed_tests)

            key="${client}_${server}"
            cpp[$key]=":white_check_mark: Passed $cpp_passed :x: Failed $cpp_failed"
            java[$key]=":white_check_mark: Passed $java_passed :x: Failed $java_failed"
          done

          echo "# Test report" >> $GITHUB_STEP_SUMMARY
          echo "|                          | VOMS AA stable ($(cat ${ARTIFACTS_PATH}/**/result-client_stable_server_stable.json | jq -r .vomsaa_version)) | VOMS AA beta ($(cat ${ARTIFACTS_PATH}/**/result-client_stable_server_beta.json | jq -r .vomsaa_version)) |" >> $GITHUB_STEP_SUMMARY
          echo "| ------------------------ | -------------- | ------------ |" >> $GITHUB_STEP_SUMMARY
          echo "| __VOMS clients cpp stable__ ($(cat ${ARTIFACTS_PATH}/**/result-client_stable_server_stable.json | jq -r .cpp_client_version))  | ${cpp[client_stable_server_stable]:-N/A} | ${cpp[client_stable_server_beta]:-N/A} |" >> $GITHUB_STEP_SUMMARY
          echo "| __VOMS clients java stable__ ($(cat ${ARTIFACTS_PATH}/**/result-client_stable_server_stable.json | jq -r .java_client_version)) | ${java[client_stable_server_stable]:-N/A} | ${java[client_stable_server_beta]:-N/A} |" >> $GITHUB_STEP_SUMMARY
          echo "| __VOMS clients cpp beta__  ($(cat ${ARTIFACTS_PATH}/**/result-client_beta_server_stable.json | jq -r .cpp_client_version))  | ${cpp[client_beta_server_stable]:-N/A} | ${cpp[client_beta_server_beta]:-N/A} |" >> $GITHUB_STEP_SUMMARY
          echo "| __VOMS clients java beta__  ($(cat ${ARTIFACTS_PATH}/**/result-client_beta_server_stable.json | jq -r .java_client_version)) | ${java[client_beta_server_stable]:-N/A} | ${java[client_beta_server_beta]:-N/A} |" >> $GITHUB_STEP_SUMMARY
        shell: bash


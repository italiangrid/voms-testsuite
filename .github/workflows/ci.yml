name: build images, deploy and run testsuite

on:
  push:
    branches:
      - all-you-can-voms

jobs:

  build-and-push-testsuite:
    name: Build & Push testsuite docker image

    strategy:
      matrix:
        rhel: [7, 9]
        repo: [stable, beta]
        include:
          - rhel: 9
            repo: beta

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to DockerHub
        uses: docker/login-action@v2 
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build & Push image
        uses: docker/build-push-action@v3
        with:
          context: docker/testsuite
          file: ./docker/testsuite/Dockerfile.centos${{ matrix.rhel }}
          push: true
          tags: italiangrid/voms-testsuite:centos${{ matrix.rhel }}-${{ matrix.repo }}
          build-args: |
            VOMS_REPO=${{ matrix.repo }}
            RHEL_VERSON=${{ matrix.rhel }}

  build-and-push-voms:
    name: Build & Push VOMS core docker image

    strategy:
      matrix:
        rhel: [7, 9]
        repo: [stable, beta]
        include:
          - rhel: 9
            repo: beta

    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to DockerHub
        uses: docker/login-action@v2 
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build & Push image
        uses: docker/build-push-action@v3
        with:
          context: docker/voms
          file: ./docker/voms/Dockerfile.centos${{ matrix.rhel }}
          push: true
          tags: italiangrid/voms:centos${{ matrix.rhel }}-${{ matrix.repo }}
          build-args: |
            VOMS_REPO=${{ matrix.repo }}
            RHEL_VERSON=${{ matrix.rhel }}

  build-and-push-voms-admin:
    name: Build & Push voms-admin docker image

    strategy:
      matrix:
        voms-admin-tag: [centos7]

    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build & Push image
        uses: docker/build-push-action@v3
        with:
          context: docker/all-in-one-centos7
          file: ./docker/all-in-one-centos7/Dockerfile
          push: true
          tags: italiangrid/voms-admin:${{ matrix.voms-admin-tag }}

  run-testsuite:
    name: Run VOMS robot testsuite

    strategy:
      matrix:
        ts-tag: [centos7, centos7-beta, centos9-beta]
        voms-tag: [centos7, centos7-beta, centos9-beta]

    runs-on: ubuntu-latest

    needs: [build-and-push-testsuite, build-and-push-voms, build-and-push-voms-admin]

    env:
      ROBOT_OPTIONS: --variable vo1:vo.0 --variable vo1_host:dev.local.io --variable vo1_issuer:/C=IT/O=IGI/CN=*.local.io --variable vo2:vo.1 --variable vo2_host:dev.local.io --variable vo2_issuer:/C=IT/O=IGI/CN=*.local.io

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Provide trustanchors
      run: docker-compose --file docker-compose.ci.yml up trust
      working-directory: compose

    - name: Start compose
      run: docker-compose --file docker-compose.ci.yml up --detach voms voms-admin testsuite
      working-directory: compose
      env:
        TS_IMAGE: italiangrid/voms-testsuite:${{ matrix.ts-tag }}
        VOMS_IMAGE: italiangrid/voms:${{ matrix.voms-tag }}

    - name: Deploy voms-admin and voms
      run: |
        docker-compose --file docker-compose.ci.yml exec -T --workdir /scripts voms-admin bash /scripts/admin_clean_EL7.sh
        docker-compose --file docker-compose.ci.yml exec -T --workdir /scripts voms bash /scripts/server_clean_EL7.sh
      working-directory: compose

    - name: Create artifacts dir
      if: ${{ always() }}
      run: |
        ARTIFACTS_PATH=${HOME}/artifacts
        echo ARTIFACTS_PATH: ${ARTIFACTS_PATH}
        # save it in the job environment
        echo "ARTIFACTS_PATH=${ARTIFACTS_PATH}" >> ${GITHUB_ENV}
        mkdir -p ${ARTIFACTS_PATH}/logs ${ARTIFACTS_PATH}/java ${ARTIFACTS_PATH}/cpp

    - name: Run testsuite for java clients
      run: docker-compose --file docker-compose.ci.yml exec -T -e ROBOT_OPTIONS="${ROBOT_OPTIONS}" testsuite bash /scripts/ci-run-testsuite.sh
      working-directory: compose

    - name: Collect test report for java clients
      if: ${{ always() }}
      run: |
        docker container cp voms-testsuite_testsuite_1:/tmp/reports ${ARTIFACTS_PATH}/java
        docker-compose --file docker-compose.ci.yml exec -T testsuite rm -rf /tmp/reports
      working-directory: compose

    - name: Run testsuite for cpp clients
      run: |
        docker-compose --file docker-compose.ci.yml exec -T -u root testsuite bash -c "update-alternatives --set voms-proxy-init /usr/bin/voms-proxy-init2; update-alternatives --set voms-proxy-info /usr/bin/voms-proxy-info2; update-alternatives --set voms-proxy-destroy /usr/bin/voms-proxy-destroy2"
        docker-compose --file docker-compose.ci.yml exec -T -e ROBOT_OPTIONS="${ROBOT_OPTIONS}" testsuite bash /scripts/ci-run-testsuite.sh --variable client_version:2 --include legacy
      working-directory: compose

    - name: Collect test report for cpp clients
      if: ${{ always() }}
      run: docker container cp voms-testsuite_testsuite_1:/tmp/reports ${ARTIFACTS_PATH}/cpp
      working-directory: compose

    - name: Collect logs
      if: ${{ always() }}
      run: |
        docker-compose --file docker-compose.ci.yml logs --no-color testsuite > ${ARTIFACTS_PATH}/logs/testsuite.log
        docker-compose --file docker-compose.ci.yml logs --no-color voms > ${ARTIFACTS_PATH}/logs/voms.log
      working-directory: compose

    - name: Stop compose
      if: ${{ always() }}
      run: docker-compose --file docker-compose.ci.yml down --volumes
      working-directory: compose

    - name: Upload artifacts
      if: ${{ always() }}
      uses: actions/upload-artifact@v3
      with:
        name: test-report-and-logs
        path: ${{ env.ARTIFACTS_PATH }}
